<app-bubbles></app-bubbles>
<app-visualizer></app-visualizer>

<app-playlist-drawer [isOpen]="isDrawerOpen()" (close)="isDrawerOpen.set(false)"></app-playlist-drawer>

<!-- Update Notification Pulse -->
<div *ngIf="updateAvailable()" class="fixed top-4 right-4 z-50 animate-bounce">
  <button (click)="reloadApp()"
    class="bg-aurora-purple text-white px-4 py-2 rounded-full shadow-lg border border-white/20 hover:bg-aurora-purple/80 transition-colors flex items-center gap-2">
    <i class="fas fa-sync-alt animate-spin"></i>
    <span>New Version Available!</span>
  </button>
</div>



<!-- Settings Toggle (Top Left) -->
<div class="fixed top-4 left-4 z-50">
  <button (click)="showSettings = !showSettings"
    class="text-white/30 hover:text-white transition-colors bg-black/20 hover:bg-black/40 p-2 rounded-full backdrop-blur-md">
    <i class="fas fa-cog text-xl" [class.animate-spin-slow]="showSettings"></i>
  </button>
</div>

<!-- Settings Panel -->
<div *ngIf="showSettings"
  class="fixed top-16 left-4 z-50 w-64 bg-aurora-dark/95 backdrop-blur-xl border border-white/10 rounded-xl p-4 shadow-2xl animate-fade-in">
  <h3 class="text-white font-bold mb-4 tracking-wider text-sm border-b border-white/10 pb-2">CUSTOMIZATION</h3>

  <!-- Visualizer Mode -->
  <div class="mb-6">
    <label class="text-xs text-white/50 uppercase font-bold mb-2 block">Visualizer</label>
    <div class="grid grid-cols-3 gap-2">
      <button (click)="audio.setVisualizerMode('bars')" [class.bg-aurora-blue]="visualizerMode() === 'bars'"
        [class.text-aurora-dark]="visualizerMode() === 'bars'"
        class="text-xs py-2 rounded bg-white/5 text-white hover:bg-white/10 transition-colors">
        BARS
      </button>
      <button (click)="audio.setVisualizerMode('wave')" [class.bg-aurora-blue]="visualizerMode() === 'wave'"
        [class.text-aurora-dark]="visualizerMode() === 'wave'"
        class="text-xs py-2 rounded bg-white/5 text-white hover:bg-white/10 transition-colors">
        WAVE
      </button>
      <button (click)="audio.setVisualizerMode('circle')" [class.bg-aurora-blue]="visualizerMode() === 'circle'"
        [class.text-aurora-dark]="visualizerMode() === 'circle'"
        class="text-xs py-2 rounded bg-white/5 text-white hover:bg-white/10 transition-colors">
        CIRCLE
      </button>
    </div>
  </div>

  <!-- Themes -->
  <div>
    <label class="text-xs text-white/50 uppercase font-bold mb-2 block">Theme</label>
    <div class="space-y-2">
      <button (click)="themeService.setTheme('aurora')"
        class="w-full flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors group">
        <div class="w-4 h-4 rounded-full bg-gradient-to-tr from-indigo-400 to-purple-400 border border-white/20"></div>
        <span class="text-sm text-white group-hover:text-aurora-blue"
          [class.font-bold]="currentTheme() === 'aurora'">Aurora (Default)</span>
      </button>
      <button (click)="themeService.setTheme('ocean')"
        class="w-full flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors group">
        <div class="w-4 h-4 rounded-full bg-gradient-to-tr from-cyan-400 to-blue-500 border border-white/20"></div>
        <span class="text-sm text-white group-hover:text-aurora-blue"
          [class.font-bold]="currentTheme() === 'ocean'">Ocean Depths</span>
      </button>
      <button (click)="themeService.setTheme('sunset')"
        class="w-full flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors group">
        <div class="w-4 h-4 rounded-full bg-gradient-to-tr from-amber-400 to-rose-500 border border-white/20"></div>
        <span class="text-sm text-white group-hover:text-aurora-blue"
          [class.font-bold]="currentTheme() === 'sunset'">Sunset Drive</span>
      </button>
    </div>
  </div>
</div>

<div class="h-screen w-full flex items-center justify-center p-8 perspective-1000">
  <div class="max-w-6xl w-full grid grid-cols-1 md:grid-cols-2 gap-12 items-center">

    <!-- Left: Album Art Section -->
    <div class="flex flex-col items-center relative group perspective-1000">
      <!-- Disk / Art -->
      <div
        class="relative w-[300px] h-[300px] md:w-[450px] md:h-[450px] transition-transform duration-700 ease-out preserve-3d group-hover:rotate-y-12">

        <!-- Glow behind -->
        <div
          class="absolute inset-0 bg-aurora-purple blur-3xl opacity-30 animate-pulse rounded-full -z-10 transform translate-z-[-50px]">
        </div>

        <div id="disk"
          class="relative w-full h-full bg-cover bg-center rounded-full shadow-2xl border-4 border-white/10 z-10"
          [style.background-image]="'url(' + (track()?.cover || '') + ')'" [class.animate-spin-slow]="isPlaying()">
          <!-- Center Hole -->
          <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-aurora-dark rounded-full border border-white/10 flex items-center justify-center">
            <div class="w-4 h-4 bg-aurora-blue rounded-full"></div>
          </div>
        </div>
      </div>

      <!-- Artist Info (Mobile Only) -->
      <div class="md:hidden mt-8 text-center text-white">
        <h1 class="text-3xl font-bold mb-2">{{ track()?.title || 'No Track Selected' }}</h1>
        <p class="text-aurora-blue/80">Premium Audio</p>
      </div>

      <!-- PWA Install Button (Mobile/Desktop) -->
      <button *ngIf="showInstallButton()" (click)="installApp()"
        class="mt-8 bg-white/10 hover:bg-white/20 text-white px-6 py-2 rounded-full backdrop-blur-md border border-white/10 transition-all transform hover:scale-105 flex items-center gap-2">
        <i class="fas fa-download"></i>
        <span>Install App</span>
      </button>
    </div>

    <!-- Right: Controls Section -->
    <div class="w-full max-w-md mx-auto">
      <app-glass-card className="w-full">

        <!-- Track Info (Desktop) -->
        <div class="hidden md:block mb-8 relative">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-xs font-bold tracking-widest text-aurora-blue mb-2 uppercase">Now Playing</h2>
              <h1 class="text-4xl font-black text-white leading-tight mb-2 truncate max-w-[250px]">{{ track()?.title ||
                'Select a Song' }}</h1>
              <p class="text-white/60">Sonic Glass Experience</p>
            </div>

            <!-- EQ Toggle -->
            <button (click)="showEQ = !showEQ" [class.text-aurora-blue]="showEQ"
              class="text-white/30 hover:text-white transition-colors p-2">
              <i class="fas fa-sliders-h text-xl"></i>
            </button>
          </div>

          <!-- EQ Panel (Absolute Overlay) -->
          <div *ngIf="showEQ"
            class="absolute top-0 right-0 w-full h-full bg-aurora-dark/95 backdrop-blur-xl rounded-xl p-4 border border-white/10 z-20 flex flex-col gap-4 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-center mb-2">
              <span class="text-xs font-bold text-white uppercase tracking-wider">Equalizer</span>
              <button (click)="showEQ = false" class="text-white/50 hover:text-white"><i
                  class="fas fa-times"></i></button>
            </div>

            <div class="flex-1 flex justify-around items-end gap-2 px-2">
              <!-- Bass -->
              <div class="flex flex-col items-center gap-2 h-full">
                <input type="range" orient="vertical"
                  class="h-24 w-1 bg-white/10 rounded-full appearance-none slider-vertical cursor-pointer" min="-10"
                  max="10" step="1" (input)="setEQ('bass', $event)">
                <span class="text-[10px] text-white/50 uppercase">Bass</span>
              </div>
              <!-- Mid -->
              <div class="flex flex-col items-center gap-2 h-full">
                <input type="range" orient="vertical"
                  class="h-24 w-1 bg-white/10 rounded-full appearance-none slider-vertical cursor-pointer" min="-10"
                  max="10" step="1" (input)="setEQ('mid', $event)">
                <span class="text-[10px] text-white/50 uppercase">Mid</span>
              </div>
              <!-- Treble -->
              <div class="flex flex-col items-center gap-2 h-full">
                <input type="range" orient="vertical"
                  class="h-24 w-1 bg-white/10 rounded-full appearance-none slider-vertical cursor-pointer" min="-10"
                  max="10" step="1" (input)="setEQ('treble', $event)">
                <span class="text-[10px] text-white/50 uppercase">High</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
          <div class="flex justify-between text-xs font-medium text-white/50 mb-2">
            <span>{{ formatTime(currentTime()) }}</span>
            <span>{{ formatTime(duration()) }}</span>
          </div>

          <div (click)="onSeek($event)"
            class="h-2 bg-white/10 rounded-full cursor-pointer relative overflow-hidden group">
            <!-- Glow on hover -->
            <div
              class="absolute inset-y-0 left-0 bg-aurora-purple/50 blur-sm w-full opacity-0 group-hover:opacity-100 transition-opacity">
            </div>

            <div class="h-full bg-gradient-to-r from-aurora-blue to-aurora-purple rounded-full relative"
              [style.width.%]="progress()">
              <!-- Handle -->
              <div
                class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-lg scale-0 group-hover:scale-100 transition-transform">
              </div>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-col gap-6">

          <!-- Volume & Interaction -->
          <div class="flex items-center justify-between px-4">
            <!-- Volume -->
            <div class="flex items-center gap-2 group w-1/3">
              <i class="fas fa-volume-down text-white/50 text-xs"></i>
              <input type="range"
                class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:opacity-0 group-hover:[&::-webkit-slider-thumb]:opacity-100 transition-all"
                min="0" max="1" step="0.01" [value]="volume()" (input)="onVolumeChange($event)">
            </div>

            <!-- Favorite -->
            <button (click)="toggleFavorite()"
              class="text-white/30 hover:text-aurora-purple transition-colors transform hover:scale-110 active:scale-95"
              [class.text-aurora-purple]="isFavorite()" [class.text-red-500]="isFavorite()"> <!-- Use red or purple -->
              <i class="fas" [class.fa-heart]="isFavorite()" [class.fa-heart-broken]="!isFavorite() && false"
                [class.far]="!isFavorite()"></i> <!-- fa-heart solid vs regular -->
              <i class="text-xl" [class.fas]="isFavorite()" [class.far]="!isFavorite()" class="fa-heart"></i>
            </button>
          </div>

          <!-- Playback Controls -->
          <div class="flex items-center justify-between px-0">

            <!-- Shuffle -->
            <button (click)="audio.toggleShuffle()" [class.text-aurora-purple]="isShuffleOn()"
              [class.text-white-40]="!isShuffleOn()"
              class="hover:text-white transition-colors p-3 rounded-full hover:bg-white/5 relative group">
              <i class="fas fa-random text-lg"></i>
              <span *ngIf="isShuffleOn()"
                class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-aurora-purple rounded-full"></span>
            </button>

            <!-- Prev -->
            <button (click)="audio.prev()"
              class="text-white/70 hover:text-white transition-colors p-4 rounded-full hover:bg-white/5">
              <i class="fas fa-step-backward text-2xl"></i>
            </button>

            <!-- Play/Pause (Animated Morph) -->
            <button (click)="audio.toggle()"
              class="w-20 h-20 flex items-center justify-center rounded-full bg-gradient-to-tr from-aurora-blue to-aurora-purple text-white shadow-lg shadow-aurora-purple/30 hover:scale-110 active:scale-95 transition-all">
              <i class="fas text-3xl" [class.fa-play]="!isPlaying()" [class.fa-pause]="isPlaying()"></i>
            </button>

            <!-- Next -->
            <button (click)="audio.next()"
              class="text-white/70 hover:text-white transition-colors p-4 rounded-full hover:bg-white/5">
              <i class="fas fa-step-forward text-2xl"></i>
            </button>

            <!-- Repeat -->
            <button (click)="audio.toggleRepeat()" [class.text-aurora-purple]="repeatMode() !== RepeatMode.OFF"
              [class.text-white-40]="repeatMode() === RepeatMode.OFF"
              class="hover:text-white transition-colors p-3 rounded-full hover:bg-white/5 relative">
              <i class="fas fa-redo text-lg"></i>
              <span *ngIf="repeatMode() === RepeatMode.ONE"
                class="absolute top-[10px] right-[8px] text-[8px] font-bold bg-aurora-dark px-1 rounded-full border border-aurora-purple text-aurora-purple">1</span>
            </button>

          </div>
        </div>

      </app-glass-card>

      <!-- Playlist Details -->
      <div class="mt-6 text-center">
        <button (click)="isDrawerOpen.set(true)"
          class="text-white/40 hover:text-white text-sm font-light tracking-wide transition-colors group">
          VIEW PLAYLIST <i class="fas fa-chevron-up ml-1 group-hover:-translate-y-1 transition-transform"></i>
        </button>
      </div>

    </div>
  </div>
</div>